import { Doughnut } from 'react-chartjs-2';
import { Chart as ChartJS, Title, Tooltip, Legend, ArcElement, CategoryScale, LinearScale } from 'chart.js';
import ChartDataLabels from 'chartjs-plugin-datalabels'; // Importamos el plugin
import PropTypes from 'prop-types';
import './RadialChart.css'
import { useState, useEffect, useMemo } from 'react';


// Registramos los elementos necesarios, incluyendo el plugin para etiquetas de datos
ChartJS.register(Title, Tooltip, Legend, ArcElement, CategoryScale, LinearScale, ChartDataLabels);

// Colores personalizados para el gráfico
const COLORS = {
  overGoal: '#FF5722',
  goalAchieved: '#66BB6A',
  remaining: '#E0E0E0'
};

// Funciones de cálculo de calorías
const calculateRemainingCalories = (dailyGoal, caloriesConsumed) => {
  return dailyGoal - caloriesConsumed;
};

const calculatePercentageCalories = (dailyGoal, caloriesConsumed) => {
  return (caloriesConsumed / dailyGoal) * 100;
};

function RadialChart({ caloriesConsumed, dailyGoal }) {
  // Calcular las calorías restantes y el porcentaje
  const remainingCalories = calculateRemainingCalories(dailyGoal, caloriesConsumed);
  const percentageCalories = calculatePercentageCalories(dailyGoal, caloriesConsumed);

  // Determinamos si el usuario se ha pasado de calorías o si ha cumplido su objetivo
  const isOverGoal = caloriesConsumed > dailyGoal;
  const isGoalAchieved = caloriesConsumed === dailyGoal;

  // Datos para el gráfico de calorías
  const caloriesData = useMemo(() => {
    return {
      labels: ['Calories Consumed', 'Calories left'],
      datasets: [{
        label: 'Calorías',
        data: isOverGoal ? [caloriesConsumed, 0] : isGoalAchieved ? [caloriesConsumed, 0] : [caloriesConsumed, remainingCalories],
        backgroundColor: isOverGoal ? [COLORS.overGoal, COLORS.remaining] : isGoalAchieved ? [COLORS.goalAchieved, COLORS.remaining] : [COLORS.goalAchieved, COLORS.remaining],
        borderColor: isOverGoal ? [COLORS.overGoal, COLORS.remaining] : isGoalAchieved ? [COLORS.goalAchieved, COLORS.remaining] : [COLORS.goalAchieved, COLORS.remaining],
        borderWidth: 0.5,
        cutout: '70%',
      }],
    };
  }, [caloriesConsumed, dailyGoal, isOverGoal, isGoalAchieved, remainingCalories]);

  // Opciones para los gráficos
  const [chartOptions, setChartOptions] = useState( {
    responsive: true,
    maintainAspectRatio: false, // Esto evita que Chart.js controle el tamaño del canvas
    plugins: {
      title: {
        display: true,
        text: 'Progress of the Day',
        font: {
          family: 'Poppins',
          size: 24,
          weight: 'bold',
        },
      },
      legend: {
        labels: {
          font: {
            size: 14, // Ajusta el tamaño de la fuente aquí
          },
        },
      },
      tooltip: {
        enabled: true,
        mode: 'nearest',
        intersect: false,
        backgroundColor: 'rgba(0, 0, 0, 0.7)',
        titleFont: {
          size: 16,
          weight: 'light',
          color: '#4F4F4F',
        },
        bodyFont: {
          size: 14,
          color: '#4F4F4F',
        },
        callbacks: {
          label: function (tooltipItem) {
            const value = tooltipItem.raw;
            const label = tooltipItem.label;
            if (label === 'Calories Consumed') {
              return `Consumed: ${value} kcal`;
            }
            return `${label}: ${value} kcal`;
          },
        },
      },
      datalabels: {
        display: false, // Desactivamos las etiquetas dentro del gráfico
      },
    },

  });


  {/*useEffect(() => {
    const handleResize = () => {
      const width = window.innerWidth;
      setChartOptions((prevOptions) => ({
        ...prevOptions,
        aspectRatio: width >= 1024 ? 0 : width >= 768 ? 1.5 : 1,  // Ajustamos según el tamaño de la pantalla
      }));
    };

    window.addEventListener('resize', handleResize);
    handleResize();  // Llamamos la función para asegurar que se ajuste desde el principio
    return () => window.removeEventListener('resize', handleResize);
  }, []);*/}
  

  

  return (
    <div className="radial-chart-container">
       {/* Título del gráfico 
    <div className="radial-chart-title">Progress of the Day</div>
    */}
      
      {/* Gráfico Circular */}
      <div className='radial-chart'>
      <Doughnut  data={caloriesData} options={chartOptions} />
      </div>
      
      {/* Número de calorías en el centro */}
      <div className='radial-chart-text'>
        {isOverGoal ? (
          <>
            <p className='radial-chart-goal exced' style={{ color: COLORS.overGoal }}>¡You've exceeded your limit!</p>
            {/*<p>{caloriesConsumed} kcal Consumed</p>*/}
          </>
        ) : isGoalAchieved ? (
          <>
            <p className='radial-chart-goal archived' style={{ color: COLORS.goalAchieved }}>¡Goal achieved!</p>
           {/*} <p>{caloriesConsumed} kcal Consumed</p>*/}
          </>
        ) : (
          <>
            {percentageCalories.toFixed(1)}% <p> Completed</p>
          </>
        )}
      </div>
      </div>
  );
}

RadialChart.propTypes = {
  caloriesConsumed:PropTypes.number.isRequired,
  dailyGoal:PropTypes.number.isRequired,
};

export default RadialChart;
