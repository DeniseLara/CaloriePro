import { auth } from '../../firebaseconfig/firebase'; // Asegúrate de importar 'auth' correctamente
import { ClipLoader } from 'react-spinners';
import { useUserData } from './useUserData'; // Asegúrate de que 'useUserData' devuelva el historial de alimentos
import { format } from 'date-fns'; // Usar para dar formato a las fechas
import './Historial.css';
import { useState } from 'react';


function Historial() {
  // Llamar al hook useUserData para obtener los datos del usuario, incluido el historial de alimentos
  const { userData, loading, error } = useUserData();  // Asegúrate de que 'userData' contenga el historial

  const user = auth.currentUser;  // Obtener el usuario autenticado

  const [visibleItems, setVisibleItems] = useState(5); // Inicialmente se mostrarán 5 elementos
  const [showAll, setShowAll] = useState(false); // Estado para controlar si mostrar todos los elementos


  if (!user) {
    return <p>No estás autenticado. Por favor, inicia sesión.</p>;
  }
  

  if (error) {
    return <p>Error al cargar el historial de alimentos: {error.message}</p>;
  }

  const handleToggle = () => {
    if (showAll) {
      setVisibleItems(5); // Vuelve a mostrar solo los primeros 5 elementos
    } else {
      setVisibleItems(foodHistory.length); // Muestra todos los elementos
    }
    setShowAll(!showAll); // Cambia el estado de mostrar todo a mostrar menos
  };

  

  // Asegurarse de que el historial de alimentos esté presente
  const foodHistory = userData?.foodHistory || [];

  return (
    <div className="historial-container">
      <h4 className="historial-title">Added calories history</h4>
      <ul className="historial-subtitle">
        <li className="historial-name">Name</li>
        <li className="historial-calories">Calories</li>
        <li className="historial-date">Date</li>
      </ul>

      {loading ? (
        <div className="loading-container">
          <ClipLoader size={60} color="#4fa94d" loading={loading} />
          <p>Loading history...</p>
        </div>

      ) : foodHistory.length > 0 ? (
        <>
          <ul className="historial-list">
            {foodHistory.slice(0, visibleItems).map((item, index) => (
              <li key={index} className="historial-item">
                <span>{item.name}</span>
                <span className="historial-item-calories">{item.calories} kcal</span>
                <span>{format(new Date(item.date), 'dd/MM/yyyy')}</span>
              </li>
            ))}
          </ul>

          {foodHistory.length > visibleItems || showAll ? (
            <button 
              className="load-more-btn" 
              onClick={handleToggle}
            >
              {showAll ? 'Show less' : 'Load more'}
            </button>
          ) : null}
        </>
      ) : (
        <p className="historial-message">You don't have any food history for today.</p>
      )}
    </div>
  );
}


export default Historial;
